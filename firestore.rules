rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    /**
     * @description This ruleset enforces a user-ownership model for image analyses. Users can create analysis requests,
     * but only the system or potentially privileged cloud functions are intended to update or delete them.
     * @data Structure: All analysis documents are stored in the top-level /analyses collection.
     * @key Security Decisions: Users can only create analyses for themselves. Updates and deletes are explicitly denied to clients.
     * @denormalization for Authorization: The `userId` field within the `Analysis` document is used to verify ownership.
     */
    match /analyses/{analysisId} {
      // Allow anyone to read the analysis
      allow get, list: if true;

      // Allow users to create an analysis if the userId matches their auth UID.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Explicitly deny update and delete operations.
      allow update, delete: if false;
    }
  }

  // Helper function to determine if a user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }
}